<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PIET — Result Lookup</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #4f46e5, #9333ea);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      color: #222;
    }
    .card {
      background: rgba(255, 255, 255, 0.98);
      border-radius: 16px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.25);
      max-width: 980px;
      width: 100%;
    }
    h4 {
      font-weight: 700;
      color: #4f46e5;
      border-bottom: 3px solid #9333ea;
      display: inline-block;
      padding-bottom: 4px;
    }
    .subject-pill {
      display:inline-block;
      margin:4px;
      padding:6px 12px;
      border-radius:20px;
      font-weight:600;
      color:#fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.18);
      font-size: 0.92rem;
    }
    .grade-A, .grade-Ap, .grade-App { background:#16a34a; } /* Greens */
    .grade-B { background:#2563eb; }
    .grade-C, .grade-D { background:#f59e0b; color:#111; }
    .grade-F { background:#dc2626; }
    .summary {
      margin-top:12px;
      font-weight:600;
      padding:10px;
      background:#f8fafc;
      border-radius:8px;
      font-size:1rem;
    }
    .footer {
      margin-top: 16px;
      text-align:center;
      color:#f1f5f9;
      font-size: 0.9rem;
    }
    .hint { font-size:0.9rem; color:#555; }
  </style>
</head>
<body>
<div class="container py-4">
  <div class="card p-4">
    <h4>PIET — Result Lookup</h4>

    <div class="row g-2 align-items-end mt-3">
      <div class="col-md-6">
        <label class="form-label">Registration Number</label>
        <!-- blank by default; tooltip instructs user -->
        <input id="reg" class="form-control" placeholder="Enter registration number (e.g. PIET23AD005)" title="Type registration number. Case doesn't matter; it will be converted to UPPERCASE." autofocus>
        <div class="hint mt-1">Tip: You can type in lowercase — we'll convert it. Example formats: <code>piet23ad005</code>, <code>PIET23CS001</code>.</div>
      </div>

      <div class="col-md-3">
        <label class="form-label">Branch</label>
        <select id="branch" class="form-select" title="Select the student's branch">
          <!-- Requested order -->
          <option value="AI&DS-E">AI&DS-E</option>
          <option value="CS(AI)-F">CS(AI)-F</option>
          <option value="CS(DS)-G">CS(DS)-G</option>
          <option value="CS">CS</option>
          <option value="CSR-D">CSR-D</option>
          <option value="CS(IOT)-H">CS(IOT)-H</option>
        </select>
      </div>

      <div class="col-md-3">
        <button id="btn" class="btn btn-primary w-100">Get Result</button>
      </div>
    </div>

    <div id="msg" class="mt-3"></div>
    <div id="results" class="mt-3"></div>

    <div class="mt-3">
      <small class="text-muted">If record is found in a different branch file, we will return it and display the actual branch.</small>
    </div>
  </div>

  <div class="footer mt-3">
    Developed by Department of AI &amp; DS, PIET Jaipur
  </div>
</div>

<script>
const btn = document.getElementById('btn');
const regInput = document.getElementById('reg');
const branchSelect = document.getElementById('branch');
const results = document.getElementById('results');
const msg = document.getElementById('msg');

function gradeClass(g){
  g = (g||'').toString().toUpperCase();
  if(g==='A++'||g==='A+') return 'grade-App';
  if(g.startsWith('A')) return 'grade-A';
  if(g.startsWith('B')) return 'grade-B';
  if(g.startsWith('C')||g.startsWith('D')) return 'grade-C';
  if(g==='F'||g.includes('FAIL')) return 'grade-F';
  return 'grade-B';
}

function escapeHtml(s){
  if(s === null || s === undefined) return '';
  return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}

btn.addEventListener('click', async ()=>{
  results.innerHTML = '';
  msg.innerHTML = '';

  // convert to uppercase before sending
  const rawReg = regInput.value.trim();
  if(!rawReg){
    msg.innerHTML = '<div class="alert alert-warning">Enter registration number.</div>';
    return;
  }
  const reg = rawReg.toUpperCase();
  const branch = branchSelect.value;

  btn.disabled = true;
  btn.innerText = 'Searching...';

  try{
    const qs = new URLSearchParams({reg, branch});
    const resp = await fetch('/api/result?'+qs.toString());
    let data;
    try { data = await resp.json(); }
    catch(e){
      msg.innerHTML = '<div class="alert alert-danger">Server returned an invalid response.</div>';
      return;
    }

    if(resp.status === 200){
      const rows = data.result || [];
      if(rows.length === 0){
        results.innerHTML = '<div class="alert alert-danger">⚠️ Record not found for that registration and branch.</div>';
      } else {
        // pick first match (usually a single row)
        const r = rows[0];
        // show branch-note when record found in different branch
        if(r["__branch__"] && r["__branch__"] !== branch){
          msg.innerHTML = `<div class="alert alert-warning">Note: record found under branch <strong>${escapeHtml(r["__branch__"])}</strong> (not the selected <strong>${escapeHtml(branch)}</strong>).</div>`;
        }

        let html = `<h5 class="mt-3">${escapeHtml(r["Name"]||'')} <small class="text-muted">(${escapeHtml(r["Reg. No"]||reg)})</small></h5>`;
        html += `<div class="text-muted mb-2">Uni-Roll: ${escapeHtml(r["Uni-Roll No"]||'')} · Col Roll: ${escapeHtml(r["Col Roll No"]||'')}</div>`;

        // subjects pills
        html += `<div class="mb-3">`;
        Object.keys(r).forEach(k=>{
          if(!["Reg. No","Name","Uni-Roll No","Col Roll No","Total Back","Result","SGPA","__branch__"].includes(k)){
            const g = r[k];
            const subjectName = k.split(" (")[0]; // remove code in parentheses
            html += `<span class="subject-pill ${gradeClass(g)}">${escapeHtml(subjectName)} — ${escapeHtml(g)}</span>`;
          }
        });
        html += `</div>`;

        // summary with badge
        const resultStatus = (r["Result"] || '').toString();
        const totalBack = escapeHtml(r["Total Back"] || '');
        const sgpa = escapeHtml(r["SGPA"] || '');
        const badge = resultStatus.toLowerCase().includes('pass')
          ? `<span class="badge bg-success">${escapeHtml(resultStatus)}</span>`
          : `<span class="badge bg-danger">${escapeHtml(resultStatus)}</span>`;

        html += `<div class="summary">SGPA: ${sgpa} · Total Back: ${totalBack} · Result: ${badge}</div>`;

        results.innerHTML = html;
      }
    } else {
      msg.innerHTML = `<div class="alert alert-danger">${escapeHtml(data.error || 'Request failed')}</div>`;
    }
  } catch(err){
    msg.innerHTML = `<div class="alert alert-danger">${escapeHtml(err.message)}</div>`;
  } finally {
    btn.disabled = false;
    btn.innerText = 'Get Result';
  }
});

// allow Enter key to trigger search
regInput.addEventListener('keydown', (ev) => {
  if(ev.key === 'Enter') {
    btn.click();
  }
});
</script>
</body>
</html>
