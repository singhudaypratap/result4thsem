<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PIET — Result Lookup</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root{
      --accent1: #4f46e5;
      --accent2: #9333ea;
      --card-bg: rgba(255,255,255,0.98);
      --muted: #6b7280;
    }

    html,body {
      height: 100%;
    }
    body {
      margin: 0;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      background: linear-gradient(135deg, var(--accent1), var(--accent2));
      color: #0f172a;
    }

    /* main container holds the card and grows */
    .main {
      flex: 1 0 auto;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 32px;
    }

    .card-outer {
      width: 100%;
      max-width: 1100px;
      background: var(--card-bg);
      border-radius: 16px;
      box-shadow: 0 12px 40px rgba(0,0,0,0.25);
      padding: 22px;
      position: relative;
    }

    h4.title {
      color: var(--accent1);
      font-weight: 800;
      margin-bottom: 6px;
      font-size: 1.75rem;
    }
    .subtitle { color: var(--muted); margin-bottom: 14px; }

    /* form area */
    .form-row { margin-bottom: 12px; }

    /* group heading */
    .group-head {
      margin-top: 18px;
      margin-bottom: 8px;
      font-weight: 800;
      color: #0f172a;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .group-head small { color: var(--muted); font-weight:600; }

    /* grid */
    .subjects-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
      margin-top: 8px;
    }

    .subject-item {
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 10px 14px;
      border-radius: 12px;
      background: #fff;
      box-shadow: 0 6px 18px rgba(15, 23, 42, 0.04);
      font-weight: 700;
      color: #0f172a;
      overflow: visible;
    }

    .subject-name {
      /* allow wrapping and long names */
      white-space: normal;
      word-break: break-word;
      margin-right: 12px;
      font-size: 0.95rem;
      line-height: 1.2;
      flex: 1 1 auto;
    }

    .subject-grade {
      min-width: 56px;
      padding: 6px 10px;
      text-align: center;
      border-radius: 8px;
      font-weight: 800;
      color: #fff;
      margin-left: 8px;
      flex: 0 0 auto;
    }

    /* grade colors */
    .g-A { background: #16a34a; }    /* A family */
    .g-B { background: #2563eb; }    /* B */
    .g-C { background: #f59e0b; color: #111; } /* C/D */
    .g-F { background: #dc2626; }    /* Fail */

    /* summary */
    .summary-row {
      display:flex;
      gap:16px;
      align-items:center;
      margin-top:18px;
      background: #f8fafc;
      padding: 14px;
      border-radius: 10px;
      flex-wrap: wrap;
    }
    .kpi { display:flex; flex-direction:column; gap:6px; }
    .kpi-title { font-size: 0.9rem; color: var(--muted); }
    .kpi-value { font-size: 1.6rem; font-weight: 800; color: #0f172a; }

    .badge-pass { background:#16a34a; color:white; padding:6px 10px; border-radius:8px; font-weight:700; }
    .badge-fail { background:#dc2626; color:white; padding:6px 10px; border-radius:8px; font-weight:700; }

    .msgbox { margin-top: 12px; }

    .disclaimer {
      margin-top: 16px;
      font-size: 0.95rem;
      color: #374151;
      background: rgba(249,250,251,0.7);
      border-left: 4px solid #eab308;
      padding: 10px 12px;
      border-radius: 8px;
    }

    /* footer fixed at bottom but not overlap card on small screens */
    footer.site-footer {
      background: transparent;
      color: #f1f5f9;
      padding: 14px 18px;
      text-align: center;
      flex-shrink: 0;
    }

    /* on larger screens show footer at right bottom inside page */
    @media(min-width: 900px){
      footer.site-footer {
        position: fixed;
        right: 28px;
        bottom: 18px;
        text-align: right;
        width: auto;
      }
    }

    /* make sure long strings don't overflow */
    code, pre { white-space: normal; word-break: break-word; }

  </style>
</head>
<body>
  <div class="main">
    <div class="card-outer" role="main" aria-labelledby="pageTitle">
      <h4 id="pageTitle" class="title">PIET — Result Lookup</h4>
      <div class="subtitle">Enter registration number below (case-insensitive). We will search all branches and return the best match.</div>

      <div class="row form-row g-2 align-items-end">
        <div class="col-md-9 col-12">
          <label class="form-label">Registration Number</label>
          <input id="reg" class="form-control" placeholder="e.g. piet23ad005" title="Type registration number; case doesn't matter. Press Enter to search." autofocus>
          <div class="small text-muted mt-1">Tip: type in lowercase or uppercase — we convert automatically.</div>
        </div>
        <div class="col-md-3 col-12">
          <button id="btn" class="btn btn-primary w-100">Get Result</button>
        </div>
      </div>

      <div id="msg" class="msgbox" aria-live="polite"></div>
      <div id="results" class="mt-3" role="region" aria-live="polite"></div>

      <div class="disclaimer">
        <strong>Disclaimer:</strong> This interface provides a quick lookup from the available result data files. While we strive for accuracy, this page is for informational purposes only — for the official, final result please consult your department tutor or the college examination office.
      </div>
    </div>
  </div>

  <footer class="site-footer">
    Developed by <strong>Department of AI &amp; DS, PIET Jaipur</strong>
  </footer>

<script>
/* UI logic — works with /api/result?reg=... */
const btn = document.getElementById('btn');
const regInput = document.getElementById('reg');
const results = document.getElementById('results');
const msg = document.getElementById('msg');

function gradeBucket(g){
  if(g === null || g === undefined) return 'g-B';
  const s = String(g).toUpperCase().trim();
  if(s === 'A++' || s === 'A+' || s.startsWith('A')) return 'g-A';
  if(s.startsWith('B')) return 'g-B';
  if(s.startsWith('C') || s.startsWith('D')) return 'g-C';
  if(s === 'F' || s.includes('FAIL')) return 'g-F';
  return 'g-B';
}
function safeText(s){ return (s===null||s===undefined) ? '' : String(s); }
function toTwoDecimals(val){
  const n = parseFloat(String(val).replace(/[^0-9.\-]/g,''));
  if(isNaN(n)) return safeText(val);
  return n.toFixed(2);
}
function escapeHtml(s){ if(s===null||s===undefined) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function isLabName(name){ if(!name) return false; return /lab/i.test(name); }

async function renderResult(regRaw){
  results.innerHTML = '';
  msg.innerHTML = '';
  const reg = String(regRaw || '').trim().toUpperCase();
  if(!reg){
    msg.innerHTML = '<div class="alert alert-warning">Enter registration number.</div>';
    return;
  }

  btn.disabled = true;
  btn.innerText = 'Searching...';

  try {
    const resp = await fetch('/api/result?'+new URLSearchParams({reg}));
    let data;
    try { data = await resp.json(); } catch(e){ msg.innerHTML = '<div class="alert alert-danger">Server returned invalid response.</div>'; return; }

    if(resp.status !== 200){
      msg.innerHTML = `<div class="alert alert-danger">${escapeHtml(data.error || 'Request failed')}</div>`;
      return;
    }

    const rows = data.result || [];
    if(rows.length === 0){
      results.innerHTML = '<div class="alert alert-danger">⚠️ Record not found for that registration.</div>';
      return;
    }

    const r = rows[0];

    // branch note
    if(r["Branch"]){
      msg.innerHTML = `<div class="alert alert-warning">Note: record found under branch <strong>${escapeHtml(r["Branch"])}</strong>.</div>`;
    }

    const studentName = safeText(r["Name"] || '');
    const regNo = safeText(r["Reg. No"] || reg);
    const uniroll = safeText(r["Uni-Roll No"] || '');
    const colroll = safeText(r["Col Roll No"] || '');

    // prepare subject keys (ignore core fields)
    const skip = new Set(["Reg. No","Name","Uni-Roll No","Col Roll No","Total Back","Result","SGPA","Branch"]);
    const subjectKeys = Object.keys(r).filter(k => !skip.has(k));
    const subjects = subjectKeys.map(k => {
      return { key: k, name: String(k).split(" (")[0], grade: r[k] };
    });

    // group into theory and labs
    const theory = subjects.filter(s => !isLabName(s.name));
    const labs = subjects.filter(s => isLabName(s.name));

    // sort alphabetically for readability
    theory.sort((a,b)=> a.name.localeCompare(b.name, undefined, {sensitivity:'base'}));
    labs.sort((a,b)=> a.name.localeCompare(b.name, undefined, {sensitivity:'base'}));

    // Build HTML
    let html = `<h3 style="margin-top:8px; margin-bottom:6px; font-weight:800;">${escapeHtml(studentName)} <small style="color:${escapeHtml('#6b7280')}; font-weight:600;">(${escapeHtml(regNo)})</small></h3>`;
    html += `<div style="color:${escapeHtml('#6b7280')}; margin-bottom:10px;">Uni-Roll: ${escapeHtml(uniroll)} · Col Roll: ${escapeHtml(colroll)}</div>`;

    if(theory.length){
      html += `<div class="group-head">THEORY <small>(${theory.length})</small></div>`;
      html += `<div class="subjects-grid">`;
      for(const s of theory){
        const cls = gradeBucket(s.grade);
        html += `<div class="subject-item"><div class="subject-name">${escapeHtml(s.name)}</div><div class="subject-grade ${cls}">${escapeHtml(s.grade)}</div></div>`;
      }
      html += `</div>`;
    }

    if(labs.length){
      html += `<div class="group-head">PRACTICAL &amp; SESSIONAL <small>(${labs.length})</small></div>`;
      html += `<div class="subjects-grid">`;
      for(const s of labs){
        const cls = gradeBucket(s.grade);
        html += `<div class="subject-item"><div class="subject-name">${escapeHtml(s.name)}</div><div class="subject-grade ${cls}">${escapeHtml(s.grade)}</div></div>`;
      }
      html += `</div>`;
    }

    // summary
    const sgpaStr = toTwoDecimals(r["SGPA"]);
    const totalBack = escapeHtml(r["Total Back"] || '');
    const resultStatus = String(r["Result"] || '');
    const isPass = resultStatus.toLowerCase().includes('pass');

    html += `<div class="summary-row"><div class="kpi"><div class="kpi-title">SGPA</div><div class="kpi-value">${escapeHtml(sgpaStr)}</div></div><div class="kpi"><div class="kpi-title">Total Back</div><div class="kpi-value" style="font-size:1.15rem">${escapeHtml(totalBack)}</div></div><div style="margin-left:auto;"><div class="${isPass ? 'badge-pass' : 'badge-fail'}">${escapeHtml(resultStatus || 'N/A')}</div></div></div>`;

    results.innerHTML = html;

  } catch (err) {
    msg.innerHTML = `<div class="alert alert-danger">${escapeHtml(err.message || 'Unknown error')}</div>`;
  } finally {
    btn.disabled = false;
    btn.innerText = 'Get Result';
  }
}

btn.addEventListener('click', ()=> renderResult(regInput.value));
regInput.addEventListener('keydown', (ev)=> { if(ev.key === 'Enter') renderResult(regInput.value); });

</script>
</body>
</html>
